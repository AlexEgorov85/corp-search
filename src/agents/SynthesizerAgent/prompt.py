# src/agents/SynthesizerAgent/prompt.py
"""
–ü—Ä–æ–º–ø—Ç –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ —Å –ø–æ–ª–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –≤—ã–≤–æ–¥–æ–º.
–ù–æ–≤–∞—è —Å—Ö–µ–º–∞:
{
  "reasoning": [
    "S1: –í—Å–µ –ª–∏ –ø–æ–¥–≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—É—á–∏–ª–∏ –æ—Ç–≤–µ—Ç?",
    "S2: –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞?",
    "S3: –ï—Å—Ç—å –ª–∏ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö?",
    "S4: –ù—É–∂–Ω–æ –ª–∏ —É—Ç–æ—á–Ω–µ–Ω–∏–µ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?"
  ],
  "synthesis": {
    "final_answer": "—Å—Ç—Ä–æ–∫–∞ ‚Äî –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç",
    "confidence": 0.0‚Äì1.0,
    "reason": "–ö—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç –Ω–∞ S1‚ÄìS4",
    "explanation": "–ß–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ"
  }
}
"""

from typing import Any, Dict
import json

def build_synthesis_prompt(
    original_question: str,
    plan: Any,
    step_outputs: Dict[str, Any],
) -> str:
    """
    –§–æ—Ä–º–∏—Ä—É–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä–∞ —Å —á—ë—Ç–∫–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –æ—Ç–≤–µ—Ç–∞.
    """
    # --- –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø–ª–∞–Ω ---
    try:
        plan_str = json.dumps(plan, ensure_ascii=False, indent=2)
    except Exception:
        plan_str = str(plan)

    # --- –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —à–∞–≥–æ–≤ ---
    try:
        outputs_str = json.dumps(step_outputs, ensure_ascii=False, indent=2)
    except Exception:
        outputs_str = str(step_outputs)

    return f"""–¢—ã ‚Äî —Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –≤ —Å–∏—Å—Ç–µ–º–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–ª–∞–Ω–∞ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —à–∞–≥–æ–≤ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å **—Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç** –Ω–∞ –∏—Å—Ö–æ–¥–Ω—ã–π –≤–æ–ø—Ä–æ—Å.

### –ò—Å—Ö–æ–¥–Ω—ã–π –≤–æ–ø—Ä–æ—Å
{original_question}

### –ü–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
{plan_str}

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —à–∞–≥–æ–≤
{outputs_str}

### üìå –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (–æ—Ç–≤–µ—Ç—å –Ω–∞ S1‚ÄìS4 –∏ –≤–∫–ª—é—á–∏ –≤ "reasoning")
S1. –í—Å–µ –ª–∏ –ø–æ–¥–≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—É—á–∏–ª–∏ –æ—Ç–≤–µ—Ç?
S2. –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞?
S3. –ï—Å—Ç—å –ª–∏ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö?
S4. –ù—É–∂–Ω–æ –ª–∏ —É—Ç–æ—á–Ω–µ–Ω–∏–µ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?

### üìè –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê
{{
  "reasoning": ["S1: ...", "S2: ...", "S3: ...", "S4: ..."],
  "synthesis": {{
    "final_answer": "—Å—Ç—Ä–æ–∫–∞ ‚Äî –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç",
    "confidence": 0.0‚Äì1.0,
    "reason": "–ö—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç –Ω–∞ S1‚ÄìS4",
    "explanation": "–ß–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ (1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)"
  }}
}}

### ‚ö†Ô∏è –í–ê–ñ–ù–û
- –ù–ò–ö–ê–ö–û–ì–û –¢–ï–ö–°–¢–ê –í–ù–ï JSON.
- –ù–∞—á–Ω–∏ —Å '{{', –∑–∞–∫–æ–Ω—á–∏ '}}'.
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π markdown, –ø–æ—è—Å–Ω–µ–Ω–∏—è, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.
"""